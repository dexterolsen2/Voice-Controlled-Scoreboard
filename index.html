<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Voice Scoreboard v9</title>
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc;
            --accent: #3b82f6; --success: #22c55e; --danger: #ef4444; --timer: #f43f5e;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg); color: var(--text);
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; margin: 0; padding: 15px; box-sizing: border-box;
        }
        #status { font-size: 0.8rem; color: #64748b; margin-bottom: 5px; font-weight: bold; }
        .listening { color: var(--success) !important; }

        .timer-container {
            font-size: 4.5rem; font-weight: 800; font-family: monospace;
            color: var(--timer); margin-bottom: 15px; cursor: pointer;
            text-shadow: 0 0 15px rgba(244, 63, 94, 0.3);
            user-select: none; -webkit-user-select: none;
        }

        .scoreboard { display: flex; gap: 15px; margin-bottom: 15px; width: 100%; max-width: 500px; }
        .team-box {
            flex: 1; background: var(--card); padding: 20px 5px; border-radius: 20px;
            text-align: center; border: 3px solid #334155; transition: 0.2s;
            user-select: none; -webkit-user-select: none; cursor: pointer;
        }
        .score { font-size: 4.5rem; font-weight: 800; margin: 0; pointer-events: none; }
        .team-label { color: #94a3b8; font-size: 0.9rem; pointer-events: none; }

        .panel {
            background: #1e293b; padding: 15px; border-radius: 15px;
            width: 100%; max-width: 500px; margin-bottom: 15px;
        }
        .setting-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; }
        input[type="text"] {
            background: #0f172a; border: 1px solid #334155; color: white;
            padding: 6px; border-radius: 5px; width: 100px;
        }
        .btn-main {
            width: 100%; padding: 12px; background: var(--accent); color: white;
            border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 5px;
        }
        .log { font-family: monospace; color: #fbbf24; font-size: 0.75rem; margin-top: 8px; text-align: center; height: 1.2em; overflow: hidden; background: #020617; padding: 2px; border-radius: 4px;}
    </style>
</head>
<body>

    <div id="status">MIC STANDBY</div>
    <div class="timer-container" id="timerDisplay" onclick="toggleTimerManual()">00:00</div>

    <div class="scoreboard">
        <div class="team-box" id="homeBox">
            <div class="team-label">HOME</div>
            <div id="homeScore" class="score">0</div>
        </div>
        <div class="team-box" id="awayBox">
            <div class="team-label">AWAY</div>
            <div id="awayScore" class="score">0</div>
        </div>
    </div>

    <div class="panel">
        <div class="setting-row">
            <label>Voice Commands</label>
            <input type="checkbox" id="voiceCmdToggle" onchange="saveSettings()">
        </div>
        <div class="setting-row">
            <label>Voice Confirmation</label>
            <input type="checkbox" id="voiceConfirmToggle" onchange="saveSettings()">
        </div>
        <div class="setting-row">
            <label>Security Phrase</label>
            <div style="display:flex; gap:5px; align-items:center;">
                <input type="checkbox" id="customToggle" onchange="saveSettings()">
                <input type="text" id="customWord" placeholder="Phrase" oninput="saveSettings()">
            </div>
        </div>
        <button id="startBtn" class="btn-main">INITIALIZE SYSTEM</button>
        <div id="lastCmd" class="log">Ready...</div>
    </div>

    <script>
        const homeDisplay = document.getElementById('homeScore');
        const awayDisplay = document.getElementById('awayScore');
        const timerDisplay = document.getElementById('timerDisplay');
        const statusText = document.getElementById('status');
        const logDisplay = document.getElementById('lastCmd');
        const startBtn = document.getElementById('startBtn');
        
        const vCmd = document.getElementById('voiceCmdToggle');
        const vConf = document.getElementById('voiceConfirmToggle');
        const cToggle = document.getElementById('customToggle');
        const cWord = document.getElementById('customWord');

        let scores = { home: 0, away: 0 };
        let timeLeft = 0; 
        let lastSetTime = 0;
        let timerInterval = null;

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const synth = window.speechSynthesis;
        let recognition;

        function saveSettings() {
            localStorage.setItem('scoreboardData', JSON.stringify({
                scores, timeLeft, lastSetTime,
                vCmd: vCmd.checked, vConf: vConf.checked,
                cToggle: cToggle.checked, cWord: cWord.value
            }));
        }

        function loadSettings() {
            const saved = localStorage.getItem('scoreboardData');
            if (saved) {
                const data = JSON.parse(saved);
                scores = data.scores || {home: 0, away: 0};
                timeLeft = data.timeLeft || 0;
                lastSetTime = data.lastSetTime || 0;
                vCmd.checked = data.vCmd ?? true;
                vConf.checked = data.vConf ?? true;
                cToggle.checked = data.cToggle ?? false;
                cWord.value = data.cWord || "";
                updateUI();
            }
        }

        function updateUI() {
            homeDisplay.innerText = scores.home;
            awayDisplay.innerText = scores.away;
            updateTimerDisplay();
        }

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onresult = (e) => {
                // FIXED: Trim transcript immediately to remove leading/trailing spaces
                const transcript = e.results[e.results.length - 1][0].transcript.trim().toLowerCase();
                if (vCmd.checked) processVoice(transcript);
            };

            recognition.onend = () => { recognition.start(); };
        }

        startBtn.onclick = () => {
            if (!recognition) return alert("Browser not supported.");
            recognition.start();
            startBtn.style.display = 'none';
            statusText.innerText = "â— SYSTEM ACTIVE";
            statusText.classList.add("listening");
        };

        function processVoice(text) {
            logDisplay.innerText = `[${text}]`; // Show brackets in log to verify space removal

            // 1. GATEKEEPER: Check for "scoreboard" or "score board"
            if (!text.match(/score\s?board/)) return;
            
            // 2. Security phrase check
            if (cToggle.checked && cWord.value) {
                const phrase = cWord.value.trim().toLowerCase();
                if (!text.includes(phrase)) return;
            }

            // 3. Status Check
            if (text.match(/current/)) {
                if (vConf.checked) speak(`Home ${scores.home}, Away ${scores.away}`);
                return;
            }

            // 4. Timer logic
            if (text.match(/start/)) { startTimer(); return; }
            if (text.match(/pause|stop/)) { pauseTimer(); return; }
            if (text.match(/reset/)) { timeLeft = lastSetTime; updateTimerDisplay(); speak("Reset"); return; }
            if (text.match(/duration|time/)) {
                const mins = parseInt(text.match(/(\d+)\s*min/)?.[1] || 0);
                const secs = parseInt(text.match(/(\d+)\s*sec/)?.[1] || 0);
                lastSetTime = (mins * 60) + secs;
                timeLeft = lastSetTime;
                updateTimerDisplay();
                speak("Timer set");
                saveSettings();
                return;
            }

            // 5. Scoring logic
            const numberMap = { 'one':1,'won':1,'two':2,'to':2,'too':2,'three':3,'tree':3,'four':4,'five':5 };
            let points = 0;

            const digitMatch = text.match(/\d+/);
            if (digitMatch) {
                points = parseInt(digitMatch[0]);
            } else {
                for (let key in numberMap) {
                    if (text.includes(key)) { points = numberMap[key]; break; }
                }
            }

            if (points === 0) return;

            // Strict Subtraction
            const isNegative = text.includes('-') || text.match(/minus|subtract|less|negative/);
            const finalPoints = isNegative ? -Math.abs(points) : Math.abs(points);

            if (text.match(/home/)) updateScore('home', finalPoints, true);
            else if (text.match(/away/)) updateScore('away', finalPoints, true);
        }

        function updateScore(team, amount, useVoice) {
            scores[team] += amount;
            updateUI();
            const box = document.getElementById(`${team}Box`);
            box.style.borderColor = amount > 0 ? "var(--success)" : "var(--danger)";
            setTimeout(() => box.style.borderColor = "#334155", 400);
            if (useVoice && vConf.checked) speak(`${team} ${scores[team]}`);
            saveSettings();
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            timerDisplay.innerText = `${m}:${s}`;
        }

        function startTimer() {
            if (timerInterval) return;
            timerInterval = setInterval(() => {
                if (timeLeft > 0) { timeLeft--; updateTimerDisplay(); } 
                else { pauseTimer(true); speak("Time is up"); }
            }, 1000);
            speak("Started");
        }

        function pauseTimer(isSilent = false) {
            clearInterval(timerInterval);
            timerInterval = null;
            if (!isSilent) speak("Paused");
            saveSettings();
        }

        function toggleTimerManual() {
            if (timerInterval) pauseTimer();
            else startTimer();
        }

        function speak(msg) {
            const u = new SpeechSynthesisUtterance(msg);
            u.rate = 1.3;
            synth.speak(u);
        }

        // Manual Controls
        [document.getElementById('homeBox'), document.getElementById('awayBox')].forEach(box => {
            const team = box.id === 'homeBox' ? 'home' : 'away';
            box.addEventListener('click', () => updateScore(team, 1, false));
            box.addEventListener('contextmenu', (e) => { e.preventDefault(); updateScore(team, -1, false); });
        });

        loadSettings();
    </script>
</body>
</html>
